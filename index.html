<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- PROD -->
    <script
      type="module"
      src="https://panenka.uefa.com/panenka/panenka.esm.js"
    ></script>
    <script
      nomodule
      src="https://panenka.uefa.com/scripts/esm-loader.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://panenka.uefa.com/panenka/panenka.css"
    />

    <title>Sponsor page</title>
    <style>
      td,
      th {
        border: 1px solid black;
        padding: 5px;
        word-wrap: break-word;
        max-width: 200px;
      }
      img {
        width: 200px;
      }
      input {
        width: 300px;
      }
      th {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="pk-root" pk-competition="default" pk-theme="dark">
      <pk-simple-header
        bg-color="primary-01"
        bg-img=""
        icon-color="ui-06"
        icon-size="24"
        close-href=""
        title-color="text-04"
        class="hydrated"
        height="60"
        width="100%"
        text="Sponsor TEST page"
        content-max-width="100%"
        style="
          --pk-simple-header--bg-color: var(--pk-primary-01);
          --pk-simple-header--title-color: var(--pk-text-04);
          --pk-simple-header--height: 60px;
          --pk-simple-header--width: 100%;
          --pk-simple-header--content-max-width: 100%;
        "
        disable-close=""
      >
      </pk-simple-header>

      <div class="pk-container">
        <div class="pk-row pk-align-items--center">
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <label for="baseUrl">ENV:</label>

            <select name="baseUrl" id="baseUrl">
              <option
                value="https://fsp-sponsor-service-prod-fcql6.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}"
              >
                PROD - need UEFA VPN
              </option>
              <option
                value="https://fsp-sponsor-service.int.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}"
              >
                INT
              </option>
            </select>
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-3">
            <input
              type="number"
              id="competitionId"
              name="competitionId"
              placeholder="Competition ID"
            />
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-3">
            <input
              type="text"
              id="countryCodes"
              name="countryCodes"
              placeholder="Country Codes - separated by commas"
              value="CN,CY,DE,EE,ES,FR,GB,IL,IS,IT,KZ,LT,LV,MC,MD,MO,NO,RU,SE,TR,UA"
            />
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <pk-button
              aria-label="button"
              appearance="contained"
              type="button"
              width="200"
              high-contrast="false"
              id="get-competition-button"
            >
              Get competition Data
            </pk-button>
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <pk-button
              aria-label="button"
              appearance="text"
              form-id=""
              link-button=""
              link-href="https://raw.githubusercontent.com/UEFADigital/fsp-sponsor-service/master/src/main/resources/countries.csv?token=GHSAT0AAAAAABL3TMCZJCSUYQW4EK2EAPVAYP5NVZA"
              link-rel="noopener"
              link-target="_blank"
              type="button"
              width=""
              high-contrast="false"
              class=""
            >
              Open country codes list
              <pk-icon
                name="navigation-chevron-right"
                class="pk-ml--8"
              ></pk-icon>
            </pk-button>
          </div>
        </div>

        <div class="pk-row pk-justify-content--center">
          <pk-spinner size="200" id="loader"></pk-spinner>
        </div>
        <div class="pk-row">
          <table id="sponsor-table" aria-describedby="sponsor-api-response">
            <thead>
              <th scope="col">language</th>
              <th scope="col">code</th>
              <th scope="col">colour</th>
              <th scope="col">secondaryColour</th>
              <th scope="col">image</th>
              <th scope="col">introText</th>
              <th scope="col">links</th>
              <th id="indexTable" scope="col">mainSponsor</th>
              <th scope="col">name</th>
              <th scope="col">tags</th>
              <th scope="col">type</th>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </body>
  <script>
    const arrayResponseHashes = [];
    document.getElementById("loader").style.display = "none";
    /*
      super simple hashing function
    */
    String.prototype.hashCode = function () {
      var hash = 0;
      for (var i = 0; i < this.length; i++) {
        var char = this.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        // Convert to 32bit integer
        hash = hash & hash;
      }
      return hash;
    };

    /*
      print column from values
    */
    const printColumn = (
      newRow,
      propValue,
      bgColor = "white",
      color = "black"
    ) => {
      const prop = newRow.insertCell();
      const propText = document.createTextNode(propValue);
      prop.appendChild(propText);
      prop.style.backgroundColor = bgColor;
      prop.style.color = color;
    };

    /*
      print column from list of values
    */
    const printColumnList = (newRow, propObj) => {
      const prop = newRow.insertCell();
      var ul = document.createElement("ul");
      for (var key in propObj) {
        var li = document.createElement("li");
        var liText = document.createTextNode(key + ": " + propObj[key]);
        li.appendChild(liText);
        ul.appendChild(li);
      }
      prop.appendChild(ul);
    };

    /*
      print columns for the 2 colors
    */
    const printColourColumns = (newRow, colour, secondaryColour) => {
      printColumn(newRow, colour, colour, secondaryColour);
      printColumn(newRow, secondaryColour, secondaryColour, colour);
    };

    /*
      onclick button handler
    */
    const getCompetitionData = () => {
      document.getElementById("loader").style.display = "block";
      //get values from inputs
      const inputValue = document.getElementById("competitionId").value;
      const inputCountryCodes = document.getElementById("countryCodes").value;
      const baseUrl = document.getElementById("baseUrl").value;
      let countryCodesArray = inputCountryCodes.split(",");
      const competitionIdArray = [inputValue].filter(Boolean);

      countryCodesArray = countryCodesArray
        .map((cc) => cc.trim().toUpperCase())
        .filter(Boolean);
      console.log("values choosen: ", competitionIdArray, countryCodesArray);
      if (competitionIdArray.length === 0) {
        alert("Please enter competition ID");
        document.getElementById("loader").style.display = "none";

        return;
      }
      if (countryCodesArray.length === 0) {
        alert("Please enter country codes");
        document.getElementById("loader").style.display = "none";

        return;
      }
      const apiCalls = [];

      const tbodyRef = document
        .getElementById("sponsor-table")
        .getElementsByTagName("tbody")[0];
      //cleanup old table
      tbodyRef.innerHTML = "";
      arrayResponseHashes.length = 0;

      //loop through comp and countries
      competitionIdArray.forEach((competitionId) => {
        countryCodesArray.forEach((countryCode) => {
          const url = baseUrl
            .replace("{competition}", competitionId)
            .replace("{countryCode}", countryCode);
          console.log(url);

          const apiCall = fetch(url)
            .then((response) => response.json())
            .then((sponsors) => {
              sponsors.forEach((sponsor) => {
                //check if hash is in array, in case add language to column
                const respHash = JSON.stringify(sponsor).hashCode();
                if (!arrayResponseHashes.includes(respHash)) {
                  arrayResponseHashes.push(respHash);
                  sponsor.language = countryCode;

                  // Insert a row at the end of table
                  const newRow = tbodyRef.insertRow();
                  newRow.id = sponsor.code;

                  // Insert a cell at the end of the row
                  printColumn(newRow, sponsor.language);
                  printColumn(newRow, sponsor.code);

                  printColourColumns(
                    newRow,
                    sponsor.colour,
                    sponsor.secondaryColour
                  );

                  const image = newRow.insertCell();
                  var img = document.createElement("img");
                  img.src = sponsor.image;
                  image.appendChild(img);

                  printColumnList(newRow, sponsor.introText.translations);
                  printColumnList(newRow, sponsor.links);

                  printColumn(newRow, sponsor.mainSponsor);
                  printColumn(newRow, sponsor.name);

                  printColumn(newRow, sponsor.tags);
                  printColumn(newRow, sponsor.type);
                } else {
                  //I find the existing row with the sponsor and I add the language to the column
                  const existingRow = document.getElementById(sponsor.code);
                  if (existingRow) {
                    let value =
                      existingRow.getElementsByTagName("TD")[0].innerHTML;
                    existingRow.getElementsByTagName("TD")[0].innerHTML =
                      value + ", " + countryCode;
                  }
                }
              });
            });
          apiCalls.push(apiCall);
        });
      });
      //and when all the api calls are done...
      Promise.all(apiCalls).then(() => {
        console.log(`All urls were fetched`);
        //order table on mainSponsor
        const thToOrderBy = document.getElementById("indexTable");
        orderTable(thToOrderBy);
        document.getElementById("loader").style.display = "none";
      });
    };

    const getCellValue = (tr, idx) =>
      tr.children[idx].innerText || tr.children[idx].textContent;

    /*
      comparer function for values in the index column
    */
    const comparer = (idx, asc) => (a, b) =>
      ((v1, v2) =>
        v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2)
          ? v1 - v2
          : v1.toString().localeCompare(v2))(
        getCellValue(asc ? a : b, idx),
        getCellValue(asc ? b : a, idx)
      );

    /*
      function to order the table based on content of the column 
    */
    const orderTable = (th) => {
      const table = th.closest("table");
      const tbody = table.querySelector("tbody");
      Array.from(tbody.querySelectorAll("tr"))
        .sort(
          comparer(
            Array.from(th.parentNode.children).indexOf(th),
            (this.asc = !this.asc)
          )
        )
        .forEach((tr) => tbody.appendChild(tr));
    };

    // set listener on th click to order by this parameter
    document.querySelectorAll("th").forEach((th) =>
      th.addEventListener("click", () => {
        orderTable(th);
      })
    );

    document
      .getElementById("get-competition-button")
      .addEventListener("click", getCompetitionData);
  </script>
</html>
