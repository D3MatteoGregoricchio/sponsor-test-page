<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Sponsor page</title>
    <style>
      td,
      th {
        border: 1px solid black;
        padding: 5px;
        word-wrap: break-word;
        max-width: 200px;
      }
      img {
        width: 200px;
      }
      input {
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h1>Sponsor TEST page - Based on INT endpoint</h1>
    <input
      type="number"
      id="competitionId"
      name="competitionId"
      placeholder="Competition ID"
    />

    <input
      type="text"
      id="countryCodes"
      name="countryCodes"
      placeholder="Country Codes - separated by commas"
      value="GB,FR,ES,IT,CN,DE,RU"
    />

    <button onclick="getCompetitionData()">Get competition Data</button>

    <a href="country-codes.csv">Download country codes list</a>

    <table id="sponsor-table">
      <thead>
        <th scope="col">language</th>
        <th scope="col">code</th>
        <th scope="col">colour</th>
        <th scope="col">secondaryColour</th>
        <th scope="col">image</th>
        <th scope="col">introText</th>
        <th scope="col">links</th>
        <th scope="col">mainSponsor</th>
        <th scope="col">name</th>
        <th scope="col">tags</th>
        <th scope="col">type</th>
      </thead>
      <tbody></tbody>
    </table>
  </body>
  <script>
    // const baseUrl =
    //   "https://fsp-sponsor-service-prod-fcql6.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}";
    const baseUrl =
      "https://fsp-sponsor-service.int.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}";
    //TODO change url in list
    //TODO order sponsors by mainSponsor
    const arrayResponseHashes = [];

    /*
    super simple hashing function
    */
    String.prototype.hashCode = function () {
      var hash = 0;
      for (var i = 0; i < this.length; i++) {
        var char = this.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        // Convert to 32bit integer
        hash = hash & hash;
      }
      return hash;
    };

    /*
    print column from values 
    */
    const printColumn = (
      newRow,
      propValue,
      bgColor = "white",
      color = "black"
    ) => {
      const prop = newRow.insertCell();
      const propText = document.createTextNode(propValue);
      prop.appendChild(propText);
      prop.style.backgroundColor = bgColor;
      prop.style.color = color;
    };

    /*
    print column from list of values
    */
    const printColumnList = (newRow, propObj) => {
      const prop = newRow.insertCell();
      var ul = document.createElement("ul");
      for (var key in propObj) {
        var li = document.createElement("li");
        var liText = document.createTextNode(key + ": " + propObj[key]);
        li.appendChild(liText);
        ul.appendChild(li);
      }
      prop.appendChild(ul);
    };

    /*
    print columns for the 2 colors
    */
    const printColourColumns = (newRow, colour, secondaryColour) => {
      printColumn(newRow, colour, colour, secondaryColour);
      printColumn(newRow, secondaryColour, secondaryColour, colour);
    };

    /*
    onclick button handler
    */
    const getCompetitionData = () => {
      //get values from inputs
      const inputValue = document.getElementById("competitionId").value;
      const inputCountryCodes = document.getElementById("countryCodes").value;
      let countryCodesArray = inputCountryCodes.split(",");
      countryCodesArray = countryCodesArray.map((cc) => cc.trim());
      console.log("values choosen: ", [inputValue], countryCodesArray);
      const competitionIdArray = [inputValue];

      const tbodyRef = document
        .getElementById("sponsor-table")
        .getElementsByTagName("tbody")[0];
      //cleanup old table
      tbodyRef.innerHTML = "";
      arrayResponseHashes.length = 0;

      //loop through comp and countries
      competitionIdArray.forEach((competitionId) => {
        countryCodesArray.forEach((countryCode) => {
          const url = baseUrl
            .replace("{competition}", competitionId)
            .replace("{countryCode}", countryCode);
          console.log(url);

          fetch(url)
            .then((response) => response.json())
            .then((sponsors) => {
              sponsors.forEach((sponsor) => {
                //check if hash is in array, in case add language to column
                const respHash = JSON.stringify(sponsor).hashCode();
                if (!arrayResponseHashes.includes(respHash)) {
                  arrayResponseHashes.push(respHash);
                  sponsor.language = countryCode;

                  // Insert a row at the end of table
                  const newRow = tbodyRef.insertRow();
                  newRow.id = sponsor.code;

                  // Insert a cell at the end of the row
                  printColumn(newRow, sponsor.language);
                  printColumn(newRow, sponsor.code);

                  printColourColumns(
                    newRow,
                    sponsor.colour,
                    sponsor.secondaryColour
                  );

                  const image = newRow.insertCell();
                  var img = document.createElement("img");
                  img.src = sponsor.image;
                  image.appendChild(img);

                  printColumnList(newRow, sponsor.introText.translations);
                  printColumnList(newRow, sponsor.links);

                  printColumn(newRow, sponsor.mainSponsor);
                  printColumn(newRow, sponsor.name);

                  printColumn(newRow, sponsor.tags);
                  printColumn(newRow, sponsor.type);
                } else {
                  //I find the existing row with the sponsor and I add the language to the column
                  const existingRow = document.getElementById(sponsor.code);
                  if (existingRow) {
                    let value =
                      existingRow.getElementsByTagName("TD")[0].innerHTML;
                    existingRow.getElementsByTagName("TD")[0].innerHTML =
                      value + ", " + countryCode;
                  }
                }
              });
            });
        });
      });
    };
  </script>
</html>
