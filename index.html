<!DOCTYPE html>
<html lang="en">

  <head>
    <!-- PROD -->
    <script type="module"
      src="https://panenka.uefa.com/panenka/panenka.esm.js"></script>
    <script nomodule
      src="https://panenka.uefa.com/scripts/esm-loader.js"></script>
    <link rel="stylesheet"
      href="https://panenka.uefa.com/panenka/panenka.css" />

    <title>Sponsor page</title>
    <style>
      td,
      th {
        border: 1px solid black;
        padding: 5px;
        word-wrap: break-word;
        max-width: 200px;
      }

      img {
        width: 200px;
      }

      input {
        width: 300px;
      }

      th {
        cursor: pointer;
      }
    </style>
  </head>

  <body style="background-color: blueviolet;">
    <div class="pk-root" pk-competition="ucl" pk-theme="dark">
      <pk-simple-header bg-color="primary-01" bg-img="" icon-color="ui-06"
        icon-size="24" close-href="" title-color="text-04" class="hydrated"
        height="60" width="100%" text="Sponsor TEST page"
        content-max-width="100%" style="
          --pk-simple-header--bg-color: var(--pk-primary-01);
          --pk-simple-header--title-color: var(--pk-text-04);
          --pk-simple-header--height: 60px;
          --pk-simple-header--width: 100%;
          --pk-simple-header--content-max-width: 100%;
        " disable-close="">
      </pk-simple-header>

      <div class="pk-container">
        <div class="pk-row pk-align-items--center">
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <label for="baseUrl">ENV:</label>

            <select name="baseUrl" id="baseUrl">
              <option
                value="https://fsp-sponsor-service-prod-fcql6.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}">
                PROD - need UEFA VPN
              </option>
              <option
                value="https://fsp-sponsor-service.int.uefa.com/v1/sponsors?competitionIds={competition}&platform=DEFAULT&countryCode={countryCode}">
                INT
              </option>
            </select>
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-3">
            <input type="number" id="competitionId" name="competitionId"
              placeholder="Competition ID" />
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-3">
            <input type="text" id="countryCodes" name="countryCodes"
              placeholder="Country Codes - separated by commas"
              value="CN,CY,DE,EE,ES,FR,GB,IL,IS,IT,KZ,LT,LV,MC,MD,MO,NO,RU,SE,TR,UA" />
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <pk-button aria-label="button" appearance="contained" type="button"
              width="200" high-contrast="false" id="get-competition-button">
              Get competition Data
            </pk-button>
          </div>
          <div class="pk-col pk-col--span-xs-4 pk-col--span-md-2">
            <pk-button aria-label="button" appearance="text" form-id=""
              link-button=""
              link-href="https://raw.githubusercontent.com/UEFADigital/fsp-sponsor-service/master/src/main/resources/countries.csv?token=GHSAT0AAAAAABL3TMCZJCSUYQW4EK2EAPVAYP5NVZA"
              link-rel="noopener" link-target="_blank" type="button" width=""
              high-contrast="false" class="">
              Open country codes list
              <pk-icon name="navigation-chevron-right" class="pk-ml--8">
              </pk-icon>
            </pk-button>
          </div>
        </div>

        <div class="pk-row">
          <pk-table table-id="sponsor-table" id="sponsor-table" loading
            aria-describedby="sponsor-api-response">
            <pk-table-header>
              <pk-table-header-col column-key="language">language
              </pk-table-header-col>
              <pk-table-header-col column-key="code">code</pk-table-header-col>
              <pk-table-header-col column-key="colour">colour
              </pk-table-header-col>
              <pk-table-header-col column-key="secondaryColour">secondaryColour
              </pk-table-header-col>
              <pk-table-header-col column-key="image">image
              </pk-table-header-col>
              <pk-table-header-col column-key="introText">introText
              </pk-table-header-col>
              <pk-table-header-col column-key="links">links
              </pk-table-header-col>
              <pk-table-header-col id="indexTable" column-key="mainSponsor">
                mainSponsor</pk-table-header-col>
              <pk-table-header-col column-key="name">name</pk-table-header-col>
              <pk-table-header-col column-key="tags">tags</pk-table-header-col>
              <pk-table-header-col column-key="type">type</pk-table-header-col>
            </pk-table-header>
            <pk-table-body>
            </pk-table-body>
          </pk-table>
        </div>
      </div>
    </div>
  </body>
  <script>
    const arrayResponseHashes = [];
    /*
      super simple hashing function
    */
    String.prototype.hashCode = function () {
      var hash = 0;
      for (var i = 0; i < this.length; i++) {
        var char = this.charCodeAt(i);
        hash = (hash << 5) - hash + char;
        // Convert to 32bit integer
        hash = hash & hash;
      }
      return hash;
    };

    /*
      print column from values
    */
    const printColumn = (
      newRow,
      propValue,
      columnKey,
      bgColor = "white",
      color = "black"
    ) => {
      const newItem = document.createElement('pk-table-cell')
      newItem.setAttribute('column-key', columnKey);
      const propText = document.createTextNode(propValue);
      newItem.appendChild(propText);
      newItem.style.backgroundColor = bgColor;
      newItem.style.color = color;
      const prop = newRow.appendChild(newItem);
    };

    /*
      print column from list of values
    */
    const printColumnList = (newRow, columnKey, propObj) => {
      const newItem = document.createElement('pk-table-cell')
      newItem.setAttribute('column-key', columnKey);
      var ul = document.createElement("ul");
      for (var key in propObj) {
        var li = document.createElement("li");
        var prefix = document.createElement('span');
        prefix.setAttribute('slot', 'prefix');
        prefix.textContent = key;
        var pkId = document.createElement('span');
        pkId.setAttribute('slot', 'primary');
        pkId.textContent = ": " + propObj[key];
        li.appendChild(prefix)
        li.appendChild(pkId)
        ul.appendChild(li);
      }
      newItem.appendChild(ul);
      newItem.style.backgroundColor = 'white';
      newItem.style.color = 'black';
      const prop = newRow.appendChild(newItem);
    };

    /*
      print columns for the 2 colors
    */
    const printColourColumns = (newRow, colour, secondaryColour) => {
      printColumn(newRow, colour, 'colour', colour, secondaryColour);
      printColumn(newRow, secondaryColour, 'secondaryColour', secondaryColour, colour);
    };

    /*
      onclick button handler
    */
    const getCompetitionData = () => {      
      //get values from inputs
      const inputValue = document.getElementById("competitionId").value;
      const inputCountryCodes = document.getElementById("countryCodes").value;
      const baseUrl = document.getElementById("baseUrl").value;
      let countryCodesArray = inputCountryCodes.split(",");
      const competitionIdArray = [inputValue].filter(Boolean);

      countryCodesArray = countryCodesArray
        .map((cc) => cc.trim().toUpperCase())
        .filter(Boolean);
      console.log("values choosen: ", competitionIdArray, countryCodesArray);
      if (competitionIdArray.length === 0) {
        alert("Please enter competition ID");        

        return;
      }
      if (countryCodesArray.length === 0) {
        alert("Please enter country codes");        

        return;
      }
      const apiCalls = [];

      const tbodyRef = document
        .getElementById("sponsor-table")
        .getElementsByTagName("pk-table-body")[0];
      //cleanup old table
      tbodyRef.innerHTML = "";
      arrayResponseHashes.length = 0;

      //loop through comp and countries
      competitionIdArray.forEach((competitionId) => {
        countryCodesArray.forEach((countryCode) => {
          const url = baseUrl
            .replace("{competition}", competitionId)
            .replace("{countryCode}", countryCode);

          const apiCall = fetch(url)
            .then((response) => response.json())
            .then((sponsors) => {
              sponsors.forEach((sponsor) => {
                //check if hash is in array, in case add language to column
                const respHash = JSON.stringify(sponsor).hashCode();
                if (!arrayResponseHashes.includes(respHash)) {
                  arrayResponseHashes.push(respHash);
                  sponsor.language = countryCode;

                  // Insert a row at the end of table
                  const newRow = document.createElement('pk-table-row');
                  tbodyRef.appendChild(newRow)
                  newRow.id = sponsor.code;

                  // Insert a cell at the end of the row
                  printColumn(newRow, sponsor.language, 'language');
                  printColumn(newRow, sponsor.code, 'code');

                  printColourColumns(
                    newRow,
                    sponsor.colour,
                    sponsor.secondaryColour
                  );

                  const image = document.createElement('pk-table-cell');
                  var img = document.createElement("img");
                  img.src = sponsor.image;
                  image.appendChild(img);
                  image.setAttribute('column-key', 'image');
                  image.style.backgroundColor = 'white';
                  image.style.color = 'black';
                  const prop = newRow.appendChild(image);

                  printColumnList(newRow, 'introText', sponsor.introText.translations);
                  printColumnList(newRow, 'links', sponsor.links);

                  printColumn(newRow, sponsor.mainSponsor, 'mainSponsor');
                  printColumn(newRow, sponsor.name, 'name');

                  printColumn(newRow, sponsor.tags, 'tags');
                  printColumn(newRow, sponsor.type, 'type');
                } else {
                  // I find the existing row with the sponsor and I add the language to the column
                  const existingRow = document.getElementById(sponsor.code);
                  if (existingRow) {
                    let value =
                      existingRow.getElementsByTagName("pk-table-cell")[0].innerHTML;
                    existingRow.getElementsByTagName("pk-table-cell")[0].innerHTML =
                      value + ", " + countryCode;
                  }
                }
              });
            });
          apiCalls.push(apiCall);
        });
      });
      //and when all the api calls are done...
      Promise.all(apiCalls).then(() => {
        console.log(`All urls were fetched`);
        //order table on mainSponsor

        // WIP
        // const thToOrderBy = document.getElementById("indexTable");
        // orderTable(thToOrderBy);              
      });
    };

    const getCellValue = (tr, idx) =>
      tr.children[idx].innerText || tr.children[idx].textContent;

    /*
      comparer function for values in the index column
    */
    const comparer = (idx, asc) => (a, b) =>
      ((v1, v2) =>
        v1 !== "" && v2 !== "" && !isNaN(v1) && !isNaN(v2)
          ? v1 - v2
          : v1.toString().localeCompare(v2))(
            getCellValue(asc ? a : b, idx),
            getCellValue(asc ? b : a, idx)
          );

    /*
      function to order the table based on content of the column 
    */
    const orderTable = (th) => {
      const table = th.closest("table");
      const tbody = table.querySelector("tbody");
      Array.from(tbody.querySelectorAll("tr"))
        .sort(
          comparer(
            Array.from(th.parentNode.children).indexOf(th),
            (this.asc = !this.asc)
          )
        )
        .forEach((tr) => tbody.appendChild(tr));
    };

    // set listener on th click to order by this parameter
    document.querySelectorAll("th").forEach((th) =>
      th.addEventListener("click", () => {
        orderTable(th);
      })
    );

    document
      .getElementById("get-competition-button")
      .addEventListener("click", getCompetitionData);
  </script>

</html>